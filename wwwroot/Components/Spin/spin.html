<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<style>
  #wheelCanvas {
    border: 1px solid #ccc;
    border-radius: 50%;
    background: #fff;
  }
  #pointer {
    width: 0;
    height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-bottom: 30px solid red;
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    transform: rotate(180deg);
  }
</style>

<div class="bg-light">
  <div class="container mt-5">
    <div class="row">
      <!-- V√≤ng quay -->
      <div class="col-md-6 text-center position-relative">
        <h4>V√≤ng quay may m·∫Øn</h4>
        <div id="pointer"></div>
        <canvas id="wheelCanvas" width="400" height="400"></canvas>
        <div class="mt-3">
          <button class="btn btn-success" id="btnSpin" disabled>Quay!</button>
        </div>
      </div>

      <!-- Th√¥ng tin kh√°ch h√†ng -->
      <div class="col-md-6">
        <h4>Th√¥ng tin kh√°ch h√†ng</h4>
        <div class="mb-3">
          <label>M√£ KH:</label>
          <input
            type="text"
            id="customerCode"
            class="form-control"
            placeholder="Nh·∫≠p m√£ KH"
          />
          <button class="btn btn-primary mt-2" id="btnCheckCustomer">
            T√¨m kh√°ch h√†ng
          </button>
        </div>
        <div id="customerInfo" style="display: none">
          <p><strong>T√™n:</strong> <span id="custName"></span></p>
          <p><strong>H·∫°ng:</strong> <span id="custRank"></span></p>
          <p><strong>Gi·ªõi t√≠nh:</strong> <span id="custGender"></span></p>
          <p><strong>Ng√†y sinh:</strong> <span id="custDOB"></span></p>
          <p><strong>T·ªïng:</strong> <span id="custTotal"></span></p>
          <p>
            <strong>V√≤ng quay √°p d·ª•ng:</strong>
            <span id="spinNameInfo"></span>
          </p>
          <p>
            <strong>S·ªë l∆∞·ª£t quay c√≤n l·∫°i:</strong>
            <span id="spinCountInfo"></span>
          </p>
        </div>
        <div
          id="spinResult"
          class="alert alert-info mt-3"
          style="display: none"
        ></div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="wwwroot/Data/data.js"></script>
  <script>
    $(function () {
      const spins = window.fakeDB.SPIN;
      const customers = window.fakeDB.CUSTOMER;
      const products = window.fakeDB.PRODUCT;

      let currentCustomer = null;
      let currentSpin = null;
      let remainingSpins = 0;
      let spinning = false;

      const canvas = document.getElementById("wheelCanvas");
      const ctx = canvas.getContext("2d");
      const wheelRadius = 180;
      let currentAngle = 0;

      function drawWheel(spin) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const n = spin.PRODUCT.length;
        const angleStep = (2 * Math.PI) / n;
        for (let i = 0; i < n; i++) {
          const startAngle = i * angleStep;
          const endAngle = startAngle + angleStep;
          ctx.beginPath();
          ctx.moveTo(canvas.width / 2, canvas.height / 2);
          ctx.arc(
            canvas.width / 2,
            canvas.height / 2,
            wheelRadius,
            startAngle,
            endAngle
          );
          ctx.fillStyle = i % 2 === 0 ? "#FFD700" : "#FF6347";
          ctx.fill();
          ctx.stroke();
          ctx.save();
          ctx.translate(canvas.width / 2, canvas.height / 2);
          ctx.rotate(startAngle + angleStep / 2);
          ctx.textAlign = "right";
          ctx.fillStyle = "#000";
          ctx.font = "14px Arial";
          const prodFull = products.find((p) => p.ID === spin.PRODUCT[i].ID);
          ctx.fillText(prodFull?.NAME || "Unknown", wheelRadius - 10, 5);
          ctx.restore();
        }
      }

      function selectSpin(customer) {
        let spin = spins.find(
          (s) =>
            s.CUSTOMER.some((cu) => cu.ID === customer.ID) &&
            new Date(s.ENDDATE) >= new Date()
        );
        if (!spin) spin = spins.find((s) => s.ISDEFAULT);
        return spin;
      }

      $("#btnCheckCustomer").click(function () {
        const code = $("#customerCode").val().trim();
        const cust = customers.find((c) => c.CODE === code);
        currentCustomer = cust || null;
        if (cust) {
          $("#customerInfo").show();
          $("#custName").text(cust.NAME);
          $("#custRank").text(cust.RANK);
          $("#custGender").text(cust["GI·ªöI T√çNH"]);
          $("#custDOB").text(cust.DOB);
          $("#custTotal").text(cust.TOTAL);

          currentSpin = selectSpin(cust);
          const spinCust = currentSpin.CUSTOMER.find((cu) => cu.ID === cust.ID);
          remainingSpins = spinCust ? spinCust.NUMBEROFSPINS : 1;

          $("#spinNameInfo").text(currentSpin.NAME);
          $("#spinCountInfo").text(remainingSpins);
          $("#btnSpin").prop("disabled", false);
          drawWheel(currentSpin);

          $("#spinResult").hide();
          alert(`Ch√∫c m·ª´ng! Kh√°ch h√†ng c√≥ ${remainingSpins} l∆∞·ª£t quay.`);
        } else {
          currentSpin = spins.find((s) => s.ISDEFAULT);
          remainingSpins = 1;
          $("#customerInfo").hide();
          drawWheel(currentSpin);
          $("#btnSpin").prop("disabled", false);
          $("#spinResult")
            .text(
              "Kh√°ch h√†ng kh√¥ng t√¨m th·∫•y. S·ª≠ d·ª•ng v√≤ng quay m·∫∑c ƒë·ªãnh 1 l∆∞·ª£t."
            )
            .show();
        }
      });

      function getRandomProduct(spin) {
        const spinProducts = spin.PRODUCT.map((sp) => {
          const fullProduct = products.find((p) => p.ID === sp.ID);
          return {
            ...fullProduct,
            RATIO: sp.RATIO || 0,
            ISDEFAULT: sp.ISDEFAULT || false,
          };
        });

        let def = spinProducts.find((p) => p.ISDEFAULT);
        if (def) return def;

        let totalRatio = spinProducts.reduce((sum, p) => sum + p.RATIO, 0);
        let rand = Math.random() * totalRatio;
        for (const p of spinProducts) {
          if (rand < p.RATIO) return p;
          rand -= p.RATIO;
        }
        return spinProducts[0];
      }

      function easeOutQuad(t) {
        return t * (2 - t);
      }

      $("#btnSpin").click(function () {
        if (spinning) return;
        if (remainingSpins <= 0) {
          alert("Kh√°ch h√†ng ƒë√£ h·∫øt l∆∞·ª£t quay!");
          return;
        }
        spinning = true;

        const chosen = getRandomProduct(currentSpin);

        const totalRatio = currentSpin.PRODUCT.reduce(
          (sum, p) => sum + (p.RATIO || 0),
          0
        );
        const angles = [];
        let startAngle = 0;
        currentSpin.PRODUCT.forEach((p) => {
          const angle = ((p.RATIO || 0) / totalRatio) * 2 * Math.PI;
          angles.push({ start: startAngle, end: startAngle + angle });
          startAngle += angle;
        });

        let targetIndex = currentSpin.PRODUCT.findIndex(
          (p) => p.ID === chosen.ID
        );
        let sector = angles[targetIndex];
        const targetAngle =
          currentAngle +
          2 * Math.PI * 8 +
          (sector.start + Math.random() * (sector.end - sector.start));

        const start = currentAngle;
        const duration = 10000;
        let startTime = null;

        function animate(timestamp) {
          if (!startTime) startTime = timestamp;
          let progress = (timestamp - startTime) / duration;
          if (progress > 1) progress = 1;
          currentAngle = start + (targetAngle - start) * easeOutQuad(progress);

          ctx.save();
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.translate(canvas.width / 2, canvas.height / 2);
          ctx.rotate(currentAngle);
          ctx.translate(-canvas.width / 2, -canvas.height / 2);
          drawWheel(currentSpin);
          ctx.restore();

          if (progress < 1) requestAnimationFrame(animate);
          else {
            spinning = false;
            remainingSpins--;
            if (currentCustomer) $("#spinCountInfo").text(remainingSpins);
            alert(`üéâ K·∫øt qu·∫£: ${chosen.NAME}`);
            $("#spinResult").text(`K·∫øt qu·∫£: ${chosen.NAME}`).show();
          }
        }
        requestAnimationFrame(animate);
      });
    });
  </script>
</div>
