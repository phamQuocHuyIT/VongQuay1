<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h4 class="m-0">Danh s√°ch th√†nh vi√™n</h4>
    <div class="d-flex gap-2 mt-2 mt-sm-0">
      <input
        type="text"
        id="searchCustomer"
        class="form-control"
        placeholder="üîç T√¨m ki·∫øm..."
      />
      <button class="btn btn-primary" id="btnAddCustomer">+ Th√™m</button>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle mb-0">
          <thead>
            <tr class="text-center bg-light">
              <th>M√£ KH</th>
              <th>T√™n kh√°ch h√†ng</th>
              <th>H·∫°ng</th>
              <th>Gi·ªõi t√≠nh</th>
              <th>Ng√†y sinh</th>
              <th>T·ªïng chi ti√™u (‚Ç´)</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="customerTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal th√™m/s·ª≠a kh√°ch h√†ng -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Th√™m th√†nh vi√™n m·ªõi</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="customerId" />
        <div class="mb-3">
          <label class="form-label">T√™n kh√°ch h√†ng</label>
          <input type="text" id="newName" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">H·∫°ng</label>
          <select id="newRank" class="form-select">
            <option value="Kim C∆∞∆°ng">Kim C∆∞∆°ng</option>
            <option value="V√†ng">V√†ng</option>
            <option value="B·∫°c">B·∫°c</option>
            <option value="ƒê·ªìng">ƒê·ªìng</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Gi·ªõi t√≠nh</label>
          <select id="newGender" class="form-select">
            <option value="Nam">Nam</option>
            <option value="N·ªØ">N·ªØ</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Ng√†y sinh</label>
          <input type="date" id="newDob" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">T·ªïng chi ti√™u (‚Ç´)</label>
          <input type="number" id="newTotal" class="form-control" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          ƒê√≥ng
        </button>
        <button type="button" class="btn btn-primary" id="saveCustomer">
          L∆∞u
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    let customers =
      JSON.parse(localStorage.getItem("customers")) || fakeDB.CUSTOMER;

    const saveToLocal = () =>
      localStorage.setItem("customers", JSON.stringify(customers));

    const renderTable = (list) => {
      let html = "";
      list.forEach((c, i) => {
        html += `
          <tr>
            <td class="text-center">${c.CODE}</td>
            <td>${c.NAME}</td>
            <td class="text-center">${c.RANK}</td>
            <td class="text-center">${c["GI·ªöI T√çNH"]}</td>
            <td class="text-center">${c.DOB}</td>
            <td class="text-end">${c.TOTAL.toLocaleString()}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-warning me-1 edit-btn" data-id="${
                c.ID
              }">‚úèÔ∏è</button>
              <button class="btn btn-sm btn-danger delete-btn" data-id="${
                c.ID
              }">üóëÔ∏è</button>
            </td>
          </tr>`;
      });
      $("#customerTable").html(html);
    };

    renderTable(customers);

    // üîç T√¨m ki·∫øm
    $("#searchCustomer").on("keyup", function () {
      const keyword = $(this).val().toLowerCase();
      const filtered = customers.filter(
        (c) =>
          c.NAME.toLowerCase().includes(keyword) ||
          c.CODE.toLowerCase().includes(keyword) ||
          c.RANK.toLowerCase().includes(keyword)
      );
      renderTable(filtered);
    });

    // ‚ûï Th√™m m·ªõi
    $("#btnAddCustomer").click(() => {
      $("#modalTitle").text("Th√™m th√†nh vi√™n m·ªõi");
      $("#customerModal input").val("");
      $("#customerModal").modal("show");
      $("#customerId").val("");
    });

    // üíæ L∆∞u
    $("#saveCustomer").click(() => {
      const id = $("#customerId").val();
      const name = $("#newName").val().trim();
      const rank = $("#newRank").val();
      const gender = $("#newGender").val();
      const dob = $("#newDob").val();
      const total = Number($("#newTotal").val());

      if (!name || !dob || isNaN(total)) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        return;
      }

      if (id) {
        // C·∫≠p nh·∫≠t
        const index = customers.findIndex((x) => x.ID == id);
        customers[index] = {
          ...customers[index],
          NAME: name,
          RANK: rank,
          "GI·ªöI T√çNH": gender,
          DOB: dob,
          TOTAL: total,
        };
      } else {
        // Th√™m m·ªõi
        const newCustomer = {
          ID: customers.length + 1,
          CODE: "C" + String(customers.length + 1).padStart(3, "0"),
          NAME: name,
          RANK: rank,
          "GI·ªöI T√çNH": gender,
          DOB: dob,
          TOTAL: total,
        };
        customers.push(newCustomer);
      }

      saveToLocal();
      renderTable(customers);
      $("#customerModal").modal("hide");
    });

    // ‚úèÔ∏è S·ª≠a kh√°ch h√†ng
    $(document).on("click", ".edit-btn", function () {
      const id = $(this).data("id");
      const c = customers.find((x) => x.ID == id);

      $("#modalTitle").text("Ch·ªânh s·ª≠a th√†nh vi√™n");
      $("#customerId").val(c.ID);
      $("#newName").val(c.NAME);
      $("#newRank").val(c.RANK);
      $("#newGender").val(c["GI·ªöI T√çNH"]);
      $("#newDob").val(c.DOB);
      $("#newTotal").val(c.TOTAL);
      $("#customerModal").modal("show");
    });

    // üóëÔ∏è X√≥a kh√°ch h√†ng
    $(document).on("click", ".delete-btn", function () {
      const id = $(this).data("id");
      if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kh√°ch h√†ng n√†y kh√¥ng?")) {
        customers = customers.filter((x) => x.ID != id);
        saveToLocal();
        renderTable(customers);
      }
    });
  });
</script>
